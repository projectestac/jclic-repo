<!--
  File    : project-download.html
  Created : 07/06/2017
  By      : Francesc Busquets <francesc@gmail.com>

  JClic Repo
  Static repository of JClic projects
  https://projectestac.github.io/jclic-repo
  https://clic.xtec.cat/repo

  @source https://github.com/projectestac/jclic-repo
  
  Based on "Polymer Starter Kit v2.0"
    https://www.polymer-project.org
    Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
    http://polymer.github.io/LICENSE.txt
  
  @license EUPL-1.1
  @licstart
  (c) 2000-2017 Catalan Educational Telematic Network (XTEC)

  Licensed under the EUPL, Version 1.1 or -as soon they will be approved by
  the European Commission- subsequent versions of the EUPL (the "Licence");
  You may not use this work except in compliance with the Licence.

  You may obtain a copy of the Licence at:
  https://joinup.ec.europa.eu/software/page/eupl

  Unless required by applicable law or agreed to in writing, software
  distributed under the Licence is distributed on an "AS IS" basis, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  Licence for the specific language governing permissions and limitations
  under the Licence.
  @licend
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/iron-ajax/iron-request.html">

<script src="../bower_components/jszip/dist/jszip.js"></script>
<script src="../bower_components/file-saver/FileSaver.js"></script>

<link rel="import" href="shared-styles.html">

<!--

....

-->

<dom-module id="project-download">
  <template>
    <style include="shared-styles">
       :host {
        @apply --project-download;
      }

      #dialog {
        max-width: 500px;
      }

      #msg {
        color: var(--primary-text-color);
        margin-bottom: 10pt;
      }

      #status {
        color: var(--secondary-text-color);
        font-size: 0.9em;
        overflow-x: hidden;
        min-height: 10pt;
      }

      #err {
        color: var(--error-color);
        font-weight: bold;
        margin-top: 10pt;
      }

      paper-progress {
        width: 100%;
        height: 8px;
        --paper-progress-active-color: var(--dark-primary-color);
      }

      @media (min-width: 601px) {
        #dialog {
          min-width: 500px;
        }
      }
    </style>

    <paper-dialog id="dialog" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
      <h2><span>[[labels.download]]</span> "<span>[[project.title]]</span>"</h2>
      <paper-dialog-scrollable>
        <div id="msg"><span>[[log_msg]]</span></div>
        <paper-progress id="progress"></paper-progress>
        <div id="status"><span>[[log_status]]</span></div>
        <div id="err"><span>[[log_err]]</span></div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button id="cancelBtn" raised on-click="_cancelDownload">[[labels.cancel]]</paper-button>
        <paper-button id="downloadBtn" raised on-click="_downloadFile">Descarrega el fitxer</paper-button>
        <paper-icon-button id="closeBtn" icon="close" title="[[labels.close]]" on-click="_cancelDownload"></paper-icon-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    class ProjectDownload extends Polymer.Element {
      static get is() { return 'project-download' }

      static get properties() {
        return {
          // Object containing the data of the JClic project currently displayed on this card
          project: Object,
          // zipFile is a BLOB
          zipFile: Object,
          zipFileName: String,
          _xhrs: Object,
          // ----------------------------------------------------------------
          // Properties used by this component but initialized in `repo-data`
          // ----------------------------------------------------------------
          // Relative path to the folder where the JClic projects of this repository are located
          repoRoot: String,
          baseUrl: String,
          // Current set of labels, titles and messages, translated into the current app language
          labels: Object,
        }
      }

      static get observers() {
        return [
          '_projectSet(project)',
          '_fileChanged(zipFile)'
        ]
      }

      _projectSet(project) {
        if (project)
          this.zipFile = null
      }

      prepareZipFile() {
        
        this._clearDlg();

        if (this.project) {

          // Start downloading
          this.log_msg = this.labels.preparingSCORM
          const zip = new JSZip()

          // Get zip file name from the last part of project path
          const basePath = `${this.repoRoot || '.'}/${this.project.path}/`
          const fileParts = basePath.split('/')
          this.zipFileName = `${fileParts[fileParts.length - 2]}.scorm.zip`

          // Detect if there is a trailing path in mainFile (usually 'jclic.js/') and save it in a regexp for later removal
          const lastSepPos = this.project.mainFile.lastIndexOf('/')
          let trailingPath = lastSepPos >= 0 ? this.project.mainFile.substring(0, lastSepPos + 1) : ''
          // Escape all the special characters -/\^$*+?.()[]{} in trailingPath. This usually will just replace '/' by '\/' and '.' by '\.'
          trailingPath = trailingPath.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')
          // Build the regExp
          const avoidDir = new RegExp(trailingPath, 'g')

          // Make a normalized copy of 'project'
          const prj = JSON.parse(JSON.stringify(this.project).replace(avoidDir, ''))
          // Delete fields added by repo-data
          delete prj.path
          delete prj.titleCmp
          delete prj.authorCmp
          delete prj.dateCmp
          // Delete fields related to clicZone and references to the old JClic format
          delete prj.zipFile
          delete prj.instFile
          delete prj.clicZoneId
          delete prj.clicZoneURL
          delete prj.clicZoneAppletURL
          // Add the modified 'project.json' to the ZIP file
          zip.file('project.json', JSON.stringify(prj, null, ' '), {})


          this.log_msg = this.labels.downloadingIngredients
          this._initProgress(this.project.files.length - 1)

          // Build an array of promises Exclude 'project.json' of the list of files to be copied
          this._xhrs = []
          const promises = []
          this.project.files
            // exclude `project.json`, already stored in the zip file
            .filter(f => f !== 'project.json')
            .forEach(file => {
              let xhr
              var filePromise = new Promise((resolve, reject) => {
                xhr = ProjectDownload.getBinaryContent(basePath + file, (err, data) => {
                  if (err)
                    reject(err)
                  else {
                    this.log_status = file
                    zip.file(file.replace(avoidDir, ''), data, { binary: true })
                    this._incProgress()
                    resolve(zip)
                  }
                })
                if (this._xhrs)
                  this._xhrs.push(xhr)
              })
              promises.push(filePromise)
            })

          // Wait for all promises to be fulfilled
          Promise.all(promises)
            .then(
            zips => {
              this._xhrs = null
              // `resolve` will return an array with the same "zip" object repeated multiple times
              this.log_msg = this.labels.pleaseWaitCompressing
              this.log_status = ''
              zips[0].generateAsync({ type: 'blob' }).then(
                // On success
                blob => {
                  this.log_msg = this.labels.zipFileAvailable
                  this.zipFile = blob
                },
                // On error
                err => {
                  this.log_err = `${this.labels.errorGeneratingZip}: ${err}`
                }
              )
            },
            // reject - Error code received
            err => {
              this._xhrs = null
              this.log_err = err
              this.log_status = ''              
            })
        }
      }

      _fileChanged(zipFile) {
        if (zipFile) {
          this.$.cancelBtn.style.display = 'none'
          this.$.downloadBtn.style.display = 'flex'
        } else {
          this.$.cancelBtn.style.display = 'flex'
          this.$.downloadBtn.style.display = 'none'
        }
      }

      _cancelDownload() {
        this._clearDlg()
        this.$.dialog.close()
        this._cancelAllXhr()
        this.zipFile = null
      }

      _clearDlg() {
        this.log_msg = ''
        this.log_status = ''
        this.log_err = ''
        this._initProgress();
      }

      _cancelAllXhr() {
        if (this._xhrs) {
          this._xhrs.forEach(xhr => {
            if (xhr.readyState < 4) {
              try {
                console.log(`Cancelling ${xhr}`)
                xhr.abort()
              } catch (err) {
                console.log(`Error cancelling XHR: ${err}`)
              }
            }
          })
          this._xhrs = null
        }
      }

      _downloadFile() {
        if (this.zipFile) {
          window.saveAs(this.zipFile, this.zipFileName)
          this._cancelDownload()
        }
      }

      _initProgress(total = 0) {
        this.$.progress.value = 0
        this.$.progress.max = total
      }

      _incProgress(value = 1) {
        this.$.progress.value += value
      }

      /**
       * Taken from Stuart Knightley's JSZipUtils
       * https://github.com/Stuk/jszip-utils
       *
       * This modified version returns an XMLHttpRequest object (or `null` in case of error), useful for
       * cancelling pending transactions at user request
       **/
      static getBinaryContent(path, callback) {
        let xhr = null
        try {
          xhr = new XMLHttpRequest()
          xhr.open('GET', path, true)
          if ("responseType" in xhr)
            xhr.responseType = "arraybuffer"
          if (xhr.overrideMimeType)
            xhr.overrideMimeType("text/plain; charset=x-user-defined")

          xhr.onreadystatechange = function (evt) {
            if (xhr.readyState === 4) {
              if (xhr.status === 200 || xhr.status === 0) {
                let file = null
                let err = null
                try {
                  // for xhr.responseText, the 0xFF mask is applied by JSZip
                  file = xhr.response || xhr.responseText
                } catch (e) {
                  err = new Error(e)
                }
                callback(err, file)
              } else
                callback(new Error(`downloading "${path}": ${this.status} - ${this.statusText}`), null)
            }
          }
          xhr.send()
        } catch (e) {
          xhr = null
          callback(new Error(e), null)
        }
        return xhr
      }
    }

    window.customElements.define(ProjectDownload.is, ProjectDownload)
  </script>
</dom-module>