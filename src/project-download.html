<!--
  File    : project-download.html
  Created : 07/06/2017
  By      : Francesc Busquets <francesc@gmail.com>

  JClic Repo
  Static repository of JClic projects
  https://projectestac.github.io/jclic-repo
  https://clic.xtec.cat/repo

  @source https://github.com/projectestac/jclic-repo
  
  Based on "Polymer Starter Kit v2.0"
    https://www.polymer-project.org
    Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
    http://polymer.github.io/LICENSE.txt
  
  @license EUPL-1.1
  @licstart
  (c) 2000-2017 Catalan Educational Telematic Network (XTEC)

  Licensed under the EUPL, Version 1.1 or -as soon they will be approved by
  the European Commission- subsequent versions of the EUPL (the "Licence");
  You may not use this work except in compliance with the Licence.

  You may obtain a copy of the Licence at:
  https://joinup.ec.europa.eu/software/page/eupl

  Unless required by applicable law or agreed to in writing, software
  distributed under the Licence is distributed on an "AS IS" basis, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  Licence for the specific language governing permissions and limitations
  under the Licence.
  @licend
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/iron-ajax/iron-request.html">

<script src="../bower_components/jszip/dist/jszip.js"></script>
<script src="../bower_components/jszip-utils/dist/jszip-utils.js"></script>
<script src="../bower_components/file-saver/FileSaver.js"></script>

<link rel="import" href="shared-styles.html">

<!--

....

-->

<dom-module id="project-download">
  <template>
    <style include="shared-styles">
       :host {
        @apply --project-download;
      }

      #dialog {
        max-width: 500px;
      }

      #log {
        height: 300px;
        overflow-y: auto;
        overflow-x: hidden;
      }

      #log>p {
        line-height: 1;
        margin: 8px;
      }

      @media (min-width: 601px) {
        #dialog {
          min-width: 500px;
        }
      }
    </style>

    <paper-dialog id="dialog" modal entry-animation="scale-up-animation" exit-animation="fade-out-animation">
      <h2><span>[[labels.download]]</span> "<span>[[project.title]]</span>"</h2>
      <paper-dialog-scrollable>
        <div id="log">

        </div>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button id="cancelBtn" raised on-click="_cancelDownload">[[labels.cancel]]</paper-button>
        <paper-button id="downloadBtn" raised on-click="_downloadFile">Descarrega el fitxer</paper-button>
        <paper-icon-button id="closeBtn" icon="close" title="[[labels.close]]" on-click="_cancelDownload"></paper-icon-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    class ProjectDownload extends Polymer.Element {
      static get is() { return 'project-download'; }

      static get properties() {
        return {
          // Object containing the data of the JClic project currently displayed on this card
          project: Object,
          // zipFile is a BLOB
          zipFile: Object,
          zipFileName: String,
          cancelFlag: Boolean,
          // ----------------------------------------------------------------
          // Properties used by this component but initialized in `repo-data`
          // ----------------------------------------------------------------
          // Relative path to the folder where the JClic projects of this repository are located
          repoRoot: String,
          baseUrl: String,
          // Current set of labels, titles and messages, translated into the current app language
          labels: Object,
        }
      }

      static get observers() {
        return [
          '_projectSet(project)',
          '_fileChanged(zipFile)'
        ];
      }

      _projectSet(project) {
        if (project)
          this.zipFile = null
      }

      prepareZipFile() {
        const logger = this._log.bind(this);
        if (this.project) {
          const projectPath = `${this.repoRoot || '.'}/${this.project.path}/project.json`
          if (!this.project.mainFile || !this.project.path) {
            logger(`ERROR: Invalid project file: ${projectPath}`)
            return;
          }
          // Start downloading
          logger(`Preparing SCORM file for "${this.project.title}"`)
          const parts = projectPath.split('/')
          this.zipFileName = `${parts[parts.length - 2]}.scorm.zip`
          const avoidDir = ProjectDownload.buildRegExp(ProjectDownload.getBasePath(this.project.mainFile), 'g')
          let files = this.project.files;
          const objects = [];
          const basePath = ProjectDownload.getBasePath(projectPath);
          // Make a normalized copy of 'project'
          const prj = JSON.parse(JSON.stringify(this.project).replace(avoidDir, ''))
          // Delete fields added by repo-data
          delete prj.path
          delete prj.titleCmp
          delete prj.authorCmp
          delete prj.dateCmp
          // Delete fields related to clicZone and references to the old JClic format
          delete prj.zipFile;
          delete prj.instFile;
          delete prj.clicZoneId;
          delete prj.clicZoneURL;
          delete prj.clicZoneAppletURL;
          // Remove 'project.json' from the list of files to be copied
          files = this.project.files.filter(f => f !== 'project.json');
          // Add the modified 'project.json' to the array of objects to be placed into the ZIP file
          objects.push({
            name: 'project.json',
            content: JSON.stringify(prj, null, ' ')
          });
          // The real work starts here: download files and add them to a 'zip' object
          ProjectDownload.buildZip(basePath, files, objects, logger, avoidDir)
            .then(
            // resolve returns an array with the same "zip" object repeated multiple times
            zip => {
              zip[0].generateAsync({ type: 'blob' }).then(
                // On success
                blob => {
                  logger('ZIP file successfully generated!');
                  this.zipFile = blob;
                },
                // On error
                err => logger(`Error generating ZIP file: ${err}`)
              );
            },
            // reject - Error code received
            err => logger(`Error collecting files: ${err}`))
        }
      }

      _fileChanged(zipFile) {
        if (zipFile) {
          this.$.cancelBtn.style.display = 'none'
          this.$.downloadBtn.style.display = 'flex'
        } else {
          this.$.cancelBtn.style.display = 'flex'
          this.$.downloadBtn.style.display = 'none'
        }
      }

      _cancelDownload() {
        this.$.dialog.close()
        this.cancelFlag = true
        this.zipFile = null
      }

      _downloadFile() {
        if (this.zipFile) {
          window.saveAs(this.zipFile, this.zipFileName)
          this._cancelDownload()
        }
      }

      _log(txt) {
        const log = this.$.log
        const p = document.createElement('p')
        p.textContent = txt
        log.appendChild(p)
        setTimeout(() => p.scrollIntoView(), 100)
      }

      // Utility functions

      // Gets the base path of the given file path (absolute or full URL). This base path always ends
      // with `/`, meaning it can be concatenated with relative paths without adding a separator.
      static getBasePath(path) {
        const p = path.lastIndexOf('/')
        return p >= 0 ? path.substring(0, p + 1) : ''
      }

      // Builds a RegExp object escaping the provided expression
      static buildRegExp(s, options) {
        return new RegExp(s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), options);
      }

      static buildZip(baseURL, files, objects, logger, avoidDir) {
        const zip = new JSZip()
        avoidDir = avoidDir || ''
        const handlers = []

        if (files)
          files.forEach(file => {
            handlers.push(new Promise((resolve, reject) => {
              logger(`Loading ${file}`)
              JSZipUtils.getBinaryContent(baseURL + file, (err, data) => {
                if (err)
                  reject(err)
                else {
                  logger(`File "${file}" has been loaded`)
                  zip.file(file.replace(avoidDir, ''), data, { binary: true })
                  resolve(zip)
                }
              });
            }));
          });

        if (objects)
          objects.forEach(obj => handlers.push(new Promise((resolve /*, reject*/) => {
            logger(`Adding ${obj.name} to the zip file`)
            zip.file(obj.name.replace(avoidDir, ''), obj.content, obj.options || {})
            resolve(zip)
          })));

        // Returns a promise
        return Promise.all(handlers)
      }

    }

    window.customElements.define(ProjectDownload.is, ProjectDownload);
  </script>
</dom-module>