<!--
  File    : projects-selector.html
  Created : 18/04/2017
  By      : Francesc Busquets <francesc@gmail.com>

  JClic Repo
  Static repository of JClic projects
  https://projectestac.github.io/jclic-repo
  https://clic.xtec.cat/repo

  @source https://github.com/projectestac/jclic-repo
  
  Based on "Polymer Starter Kit v2.0"
    https://www.polymer-project.org
    Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
    http://polymer.github.io/LICENSE.txt
  
  @license EUPL-1.1
  @licstart
  (c) 2000-2017 Catalan Educational Telematic Network (XTEC)

  Licensed under the EUPL, Version 1.1 or -as soon they will be approved by
  the European Commission- subsequent versions of the EUPL (the "Licence");
  You may not use this work except in compliance with the Licence.

  You may obtain a copy of the Licence at:
  https://joinup.ec.europa.eu/software/page/eupl

  Unless required by applicable law or agreed to in writing, software
  distributed under the Licence is distributed on an "AS IS" basis, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  Licence for the specific language governing permissions and limitations
  under the Licence.
  @licend
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu-light.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="shared-icons.html">

<!--

This component provides user input controls for searching specific content in the repository of JClic projects.
The search criteria is dynamically stored in a compound object called `filter`, usually provided by `repo-data`.
Changes in this object should trigger a refresh in the main projects showcase.

### Styling

The following custom properties and mixins are available for styling:

Custom property       | Description                          | Default
----------------------|--------------------------------------|----------
`--search-button`     | Mixin applied to the "Search" button | `{}`
`--projects-selector` | Mixin applied to the selector        | `{}`

-->

<dom-module id="projects-selector">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
        padding: 1em;
        @apply --projects-selector;
      }

      paper-dropdown-menu-light {
        width: 100%;
        --paper-item-min-height: 2em;
        --paper-item: {
          cursor: pointer;
        }
      }

      #searchBtn {
        margin-top: 15px;
        margin-left: 0;
        background-color: var(--default-primary-color);
        color: var(--text-primary-color);
        @apply --search-button;
      }

      h4 {
        color: var(--secondary-text-color);
        margin-bottom: 0;
      }
    </style>

    <h4>[[labels.searchTitle]]</h4>

    <paper-dropdown-menu-light id="dropLang" label="[[labels.languages]]">
      <paper-listbox slot="dropdown-content" class="dropdown-content" on-iron-select="readFilterValues">
        <template is="dom-repeat" items="[[selectOptions.languages]]">
          <paper-item data-type="language" data-val$="[[item.val]]">[[item.text]]</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu-light>

    <paper-dropdown-menu-light id="dropSubj" label="[[labels.subjects]]">
      <paper-listbox slot="dropdown-content" class="dropdown-content" on-iron-select="readFilterValues">
        <template is="dom-repeat" items="[[selectOptions.subjects]]">
          <paper-item data-type="subject" data-val$="[[item.val]]">[[item.text]]</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu-light>

    <paper-dropdown-menu-light id="dropLev" label="[[labels.levels]]">
      <paper-listbox slot="dropdown-content" class="dropdown-content" on-iron-select="readFilterValues">
        <template is="dom-repeat" items="[[selectOptions.levels]]">
          <paper-item data-type="level" data-val$="[[item.val]]">[[item.text]]</paper-item>
        </template>
      </paper-listbox>
    </paper-dropdown-menu-light>

    <paper-input id="title" class="textInput" label="[[labels.title]]" on-change="readFilterValues"></paper-input>
    <paper-input id="author" class="textInput" label="[[labels.author]]" on-change="readFilterValues"></paper-input>

    <paper-button raised class="search" on-click="readFilterValues" id="searchBtn">
      <iron-icon icon="search" class="small" style="margin-right: 4px;"></iron-icon>
      <span>[[labels.search]]</span>
    </paper-button>

  </template>

  <script>
    class ProjectsSelector extends Polymer.MutableData(Polymer.Element) {
      static get is() { return 'projects-selector' }
      static get properties() {
        return {
          // Current set of labels, titles and messages, translated into the current app language. Initialized and updated in `repo-data`.
          labels: Object,
          // Current choices of languages, subjects and levels, expresed in the current language and used to filter the main project list. Initialized and updated in `repo-data`.
          selectOptions: Object,
          // Current set of filter and search options. Also initialized and updated in `repo-data`.
          filter: {
            type: Object,
            notify: true,
          },
          // Array with the field names currently used in `filter`
          filterFields: {
            type: Array,
            value: () => { return ['language', 'subject', 'level', 'title', 'author'] },
          }
        }
      }

      // Checks if the content of the provided object `f` is equivalent to the current filter settings
      // Returns `true` when `this.filter` has not been created, or when the value of any of its fields differs from the value of the same field in `f`
      filterDiffers(f) {
        return !this.filter || this.filterFields.find(ff => this.filter[ff] !== f[ff])
      }

      // Reads the values stored in the form controls, and sets a new value for `this.flter` if any difference is found
      readFilterValues(ev) {
        const f = {
          language: this.$.dropLang.contentElement.selectedItem ? this.$.dropLang.contentElement.selectedItem.dataset.val : '*',
          subject: this.$.dropSubj.contentElement.selectedItem ? this.$.dropSubj.contentElement.selectedItem.dataset.val : '*',
          level: this.$.dropLev.contentElement.selectedItem ? this.$.dropLev.contentElement.selectedItem.dataset.val : '*',
          title: this.$.title.value || '',
          author: this.$.author.value || '',
        }
        if(this.filterDiffers(f))
          this.filter = f
      }

      // Sets a new value for `this.filter` and updates the form controls accordingly
      setFilter(f) {
        if (this.filterDiffers(f)) {
          this.filter = f
          this.$.dropLang.contentElement.selected = this.selectOptions.findIndex('languages', f.language || '*')
          this.$.dropSubj.contentElement.selected = this.selectOptions.findIndex('subjects', f.subject || '*')
          this.$.dropLev.contentElement.selected = this.selectOptions.findIndex('levels', f.level || '*')
          this.$.title.value = f.title || ''
          this.$.author.value = f.author || ''
        }
      }
    }

    window.customElements.define(ProjectsSelector.is, ProjectsSelector)
  </script>
</dom-module>