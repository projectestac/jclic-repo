<!--
  File    : jclic-repo.html
  Created : 13/04/2017
  By      : Francesc Busquets <francesc@gmail.com>

  JClic Repo
  Static repository of JClic projects
  https://projectestac.github.io/jclic-repo
  https://clic.xtec.cat/repo

  @source https://github.com/projectestac/jclic-repo
  
  Based on "Polymer Starter Kit v2.0"
    https://www.polymer-project.org
    Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
    http://polymer.github.io/LICENSE.txt
  
  @license EUPL-1.1
  @licstart
  (c) 2000-2017 Catalan Educational Telematic Network (XTEC)

  Licensed under the EUPL, Version 1.1 or -as soon they will be approved by
  the European Commission- subsequent versions of the EUPL (the "Licence");
  You may not use this work except in compliance with the Licence.

  You may obtain a copy of the Licence at:
  https://joinup.ec.europa.eu/software/page/eupl

  Unless required by applicable law or agreed to in writing, software
  distributed under the Licence is distributed on an "AS IS" basis, WITHOUT
  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
  Licence for the specific language governing permissions and limitations
  under the Licence.
  @licend
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<!-- link rel="import" href="../bower_components/app-route/app-location.html" -->
<!-- link rel="import" href="../bower_components/app-route/app-route.html" -->
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">


<link rel="import" href="shared-icons.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="repo-data.html">
<link rel="import" href="projects-list.html">
<link rel="import" href="projects-selector.html">
<link rel="import" href="big-project-card.html">
<link rel="import" href="jclic-player.html">
<link rel="import" href="user-settings.html">
<link rel="import" href="info-pages.html">

<!--

This is the shell component of the basic JClic-repo app.

The component contains an `app-drawer-layout` with three main zones:
- An `app-drawer` placed at left, containing a `projects-selector` and an `info-pages` component.
- An `app-header` containing an `app-toolbar` with title and language selector
- The main showcase of JClic projects, presented as small `project-card` components into a `projects-list`.

Some other functional components are also declared and included at this level:
- A `paper-spinner-lite`, used to display an animation while waiting for data
- A `big-project-card` where the project's full description will be shown
- An `user-settings` dialog
- A `jclic-player` component, used to launch the JClic activities on request
- A `repo-data` component, without any graphic element, responsible of data retrieval and orchestration.

-->

<dom-module id="jclic-repo">
  <template>
    <style include="shared-styles">
       :host {
        display: block;
      }

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: var(--text-primary-color);
        background-color: var(--default-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: var(--text-primary-color);
      }

      #langSelector {
        font-size: 12pt;
      }

      .langItem {
        color: var(--text-primary-color);
        text-decoration: none;
        padding: 0 0.3em;
        border-right: 1pt solid;
      }

      .langItem:last-of-type {
        border-right: none;
        padding-right: 0;
      }

      .currentLang {
        font-weight: 800;
      }
      /* Workaround to avoid the default -120px bottom position in app-drawer: */

      #drawer {
        bottom: 0;
      }

      .footer {
        color: var(--secondary-text-color);
        display: flex;
        align-items: center;
        position: absolute;
        bottom: 0;
        width: 100%;
      }

      .numProjects {
        font-size: 10pt;
        margin: 8px;
        text-align: right;
        flex-grow: 2;
      }

      #spinner {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      #mainContainer {
        background-color: var(--projects-list-background-color);
      }
    </style>

    <app-drawer-layout fullbleed>

      <!-- Drawer content -->
      <app-drawer id="drawer" slot="drawer">
        <projects-selector id="selector" labels="[[labels]]" select-options="[[selectOptions]]" filter="{{filter}}"></projects-selector>
        <div class="footer">
          <paper-icon-button id="settingsBtn" icon="settings" title="[[labels.settings]]" on-click="_setUserSettings"></paper-icon-button>
          <paper-icon-button id="infoBtn" icon="info" title="[[labels.about]]" on-click="_displayInfo"></paper-icon-button>
          <span class="numProjects">[[projects.length]] [[labels.projects]]</span>
        </div>
      </app-drawer>

      <!-- Main content -->
      <app-header-layout id="mainContainer" has-scrolling-region>
        <!-- Title bar -->
        <app-header slot="header" condenses reveals effects="waterfall">
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <div main-title>[[labels.mainTitle]]</div>
            <div id="langSelector">
              <template is="dom-repeat" items="[[settings.languages]]"><a href="#" class="langItem" id="[[item.id]]" title="[[item.name]]" on-click="_clickOnLang">[[item.id]]</a></template>
            </div>
          </app-toolbar>
        </app-header>
        <iron-pages attr-for-selected="page" selected="[[page]]">
          <section page="projects">
            <!-- Projects showcase -->
            <projects-list name="projects" main-container="[[_getMainContainer()]]" repo-root="[[repoRoot]]" projects="[[projects]]"
              labels="[[labels]]" on-play="playProject" on-show="showProject"></projects-list>
          </section>
          <section page="info">
            <!-- Info pages -->
            <info-pages id="info" settings="[[settings]]" lang="[[lang]]" labels="[[labels]]" on-close="_closeInfo"></info-pages>
          </section>
        </iron-pages>
      </app-header-layout>

    </app-drawer-layout>

    <!-- Animated image displayed while waiting for data -->
    <paper-spinner-lite active="true" id="spinner" alt="[[labels.loading]]"></paper-spinner-lite>

    <!-- Project card, dynamically filled on demand with the current project data -->
    <big-project-card id="bigPrj" lang="[[lang]]" labels="[[labels]]" repo-root="[[repoRoot]]" base-url="[[baseUrl]]" settings="[[settings]]"
      on-iron-overlay-opened="_dlgOpened" on-iron-overlay-closed="_projectClosed" on-play="playProject"></big-project-card>

    <!-- Dialog used to set user perferences about ordering and full-screen -->
    <user-settings id="userSettings" labels="[[labels]]" ordering="{{ordering}}" full-screen-player="{{fullScreenPlayer}}"></user-settings>

    <!-- A JClic player where the selected project will be launched at user's request -->
    <jclic-player id="player" full-screen="[[fullScreenPlayer]]" options="[[playerOptions]]"></jclic-player>

    <!-- Auxiliary element used for miscellaneous operations related to the repository data -->
    <repo-data id="repo" repo-root="{{repoRoot}}" settings="{{settings}}" lang="[[lang]]" labels="{{labels}}" select-options="{{selectOptions}}"
      projects="{{projects}}" filter="{{filter}}" ordering="{{ordering}}"></repo-data>

  </template>

  <script>
    Polymer({
      is: 'jclic-repo',
      properties: {
          // Parametres passed via the `query` section of the current URL
          params: {
            type: Object,
            value: null
          },
          // Current two-letter language code selected by the user
          lang: {
            type: String,
            notify: true
          },
          // Flag indicating whether JClic player has to open in full-screen mode or just inside the current window
          fullScreenPlayer: {
            type: Boolean,
            value: false
          },
          // Miscellaneous options passed to JClic player
          playerOptions: {
            type: Object,
            value: {}
          },
          // URL used as a base for absolute references to project's components
          baseUrl: {
            type: String,
            computed: '_getBaseUrl()',
          },
          // Relative path of current project
          currentProjectId: String,
          // Main page to be display on the main app area. Valid options are: `projects` and `info`
          page: {
            type: String,
            value: 'projects',
          },
          //
          // -----------------------------------------------------------------------------------
          // Other variables used in this component but declared and initialized in `repo-data`:
          // -----------------------------------------------------------------------------------
          // Relative path to the folder where the JClic projects of this repository are located
          repoRoot: String,
          // Main settings of the app, loaded at startup from `main.json`
          settings: Object,
          // Current choices of languages, subjects and levels, expresed in the current language and used to filter the main project list
          selectOptions: Object,
          // Current set of filtering and searching options
          filter: Object,
          // Current ordering options
          ordering: Object,
          // Ordered array containing the colection of projects matching the current filter settings
          projects: Object,
          // Current set of labels, titles and messages, translated into the current app language
          labels: Object,
        },
        observers: [
          '_checkPreferredLanguage(settings)',
          '_checkParams(projects, params)',
          '_langSelected(lang)',
          '_queryChanged(currentProjectId, filter, params, lang)'
        ],
              // Used to pass `mainContainer` to `projects-list` (needed for dynamic scrolling)
      _getMainContainer: function() {
        return this.$.mainContainer;
      },

      // Gets the URL used as a base for absolute links to projects
      _getBaseUrl: function() {
        var path = window.location.pathname;
        var p = path.lastIndexOf('/');
        path = path.substring(0, p) + '/';
        return window.location.origin + path;
      },

      // Triggered when the user chooses a language
      _clickOnLang: function(e) {
        e.preventDefault();
        this.lang = this.settings.languages[e.model.index].id;
        this._queryChanged();
        return false;
      },

      // Updates the language selector, displaying in bold type the current one
      _langSelected: function(lang) {
        lang = lang || this.lang;
        if (lang) {
          this.$.langSelector.querySelectorAll('.langItem').forEach(l => {
            if (l.id === lang)
              l.classList.add('currentLang');
            else
              l.classList.remove('currentLang');
          })
        }
      },

      // Triggered by settings button
      _setUserSettings: function() {
        this.$.userSettings.open();
      },

      // Triggered by info button
      _displayInfo: function() {
        const search = `?lang=${this.lang}&page=info`;
        if (search !== window.location.search)
          window.history.pushState({}, '', `index.html${search}`);
        this.page = 'info';
      },

      // Called when the user closes the info pages
      _closeInfo: function() {
        this.page = 'projects';
        this._queryChanged();
      },

      // Opens a big project card with a specific project data
      showProject: function(path) {
        // Check if `path` is a custom event fired by a project-card
        if (path instanceof CustomEvent)
          path = path.detail.path;
        this.$.spinner.active = true;
        this.$.repo.loadProject(path).then(
          // Promise OK
          project => {
            this.$.spinner.active = false;
            this.$.bigPrj.project = project;
            this.$.bigPrj.$.dialog.open();
            this.currentProjectId = project.path;
          },
          // Promise rejected
          err => {
            this.$.spinner.active = false;
            console.log(`Error loading project ${path}: ${err}`);
          })
      },

      // Called when `big-project-card` is closed
      _projectClosed: function() {
        if (!this.$.player.project) {
          this.currentProjectId = null;
          this._queryChanged();
        }
      },

      // Launches the project activities
      playProject: function(prj) {
        // Check if `prj` is a custom event fired by a `project-card` or a `big-project-card`
        if (prj instanceof CustomEvent) {
          prj = prj.detail.project;
          this.$.bigPrj.close();
        }
        // Request a call to `playerClosed` when the user leaves the JClic player
        this.playerOptions.closeFn = this.playerClosed.bind(this);
        // Setting the `project` attribute of the `jclic-player` component opens automatically the player
        this.$.player.project = `${this.repoRoot}/${prj.path}/${prj.mainFile}`;
        this.currentProjectId = prj.path;
        this._queryChanged();
      },

      // Called by `jclic-player` when the user leaves the activities
      playerClosed: function() {
        this.$.player.project = null;
        this.currentProjectId = null;
        this._queryChanged();
      },

      // called when a new dialog opens
      _dlgOpened: function() {
        // Force a `resize` event to adjust the real size of dialogs even after its content has been modified
        setTimeout(() => dispatchEvent(new Event('resize')), 100)
      },

      // Called by Polymer when all components have been initialized
      ready: function() {
        //super.ready()

        // Read the parameters passed on the `search` section of current URL, if any
        // From: http://stackoverflow.com/questions/8648892/convert-url-parameters-to-a-javascript-object
        this.params = window.location.search
          ? window.JSON.parse('{"' + window.decodeURI(window.location.search.substring(1)).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g, '":"') + '"}')
          : {}
        if (this.params.logLevel)
          this.playerOptions.logLevel = this.params.logLevel
        if (this.params.page && this.params.page === 'info')
          this._displayInfo()
      },

      // Try to determine the user's preferred language
      _checkPreferredLanguage: function(settings) {
        if (settings && settings.languages && settings.languages.length) {
          // Stop waiting animation, if already running
          this.$.spinner.active = false
          // Create an array to store possible values
          var tries = []
          // If "lang=" was programatically set, check it
          if (this.lang)
            tries.push(this.lang)
          // If "lang=" was on location.search, check it
          if (this.params && this.params.lang)
            tries.push(this.params.lang)
          // Add user's preferred languages, if any
          if (window.navigator.languages)
            tries = tries.concat(window.navigator.languages)
          // Add the navigator main language, if defined
          if (window.navigator.language)
            tries.push(window.navigator.language)
          this.lang = (tries.find(v => settings.languages.find(l => v.indexOf(l.id) === 0) !== undefined) || 'en').substr(0, 2)

          // Workaround to set/unset the "langSelected" class to langItems in #langSelector when dom-repeat finishes
          var thisRepo = this
          setTimeout(() => thisRepo._langSelected(), 100)
        }
      },

      // Opens the big project card of the project passed as a parameter in the query section of the current URL
      _checkParams: function(projects, params) {
        if (projects && projects.length > 0 && params) {
          if (projects.length > 0 && params.prj) {
            if (projects.find(p => p.path === params.prj))
              this.showProject(params.prj)
            else
              console.log(`Unknown project: ${params.prj}`)
            params.prj = null
          }
          else if (params.language || params.subject || params.level || params.title || params.author) {
            this.$.selector.setFilter({
              language: params.language || '*',
              subject: params.subject || '*',
              level: params.level || '*',
              title: params.title || '',
              author: params.author || '',
            })
            params.language = params.subject = params.level = params.title = params.author = null
            this._queryChanged()
          }
          params.processed = true
        }
      },

      // Updates the current window URL with the params needed to reproduce current state
      _queryChanged: function() {
        if (this.params && this.params.processed) {
          this.page = 'projects'
          let search = `?lang=${this.lang}`
          if (this.currentProjectId)
            search = `${search}&prj=${this.currentProjectId}`
          else if (this.filter) {
            ['language', 'subject', 'level', 'title', 'author'].forEach(f => {
              if (this.filter[f] && this.filter[f] !== '*')
                search = `${search}&${f}=${encodeURIComponent(this.filter[f])}`
            })
          }
          if (search !== window.location.search)
            window.history.pushState({}, '', `index.html${search}`)
        }
      }
    });

  </script>
</dom-module>